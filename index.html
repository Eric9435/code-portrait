<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text Portrait Auto</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <section>
    <p id="portrait"></p>
  </section>

  <canvas id="an" style="display:none"></canvas>

  <script>
    const P = document.getElementById("portrait");
    const an = document.getElementById("an");
    const ax = an.getContext("2d", { willReadFrequently: true });

    // ✅ 1) Auto text (adjust count if you want)
    const base = "Lorem ipsum dolor sit amet consectetur adipisicing elit. ";
    let big = "";
    for (let i = 0; i < 10000; i++) big += base;
    P.textContent = big;

    // ✅ 2) Load image (must exist)
    const img = new Image();
    img.src = "./face.jpg";

    img.onload = () => {
      // A) Auto aspect ratio so dimension is perfect
      P.style.aspectRatio = `${img.width} / ${img.height}`;

      // B) Analyze brightness quickly (downsample)
      const W = 140;
      const H = Math.max(60, Math.round(W * (img.height / img.width)));
      an.width = W;
      an.height = H;

      drawCover(ax, img, W, H);
      const { data } = ax.getImageData(0, 0, W, H);

      let sum = 0;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i + 1], b = data[i + 2];
        const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
        sum += lum;
      }
      const avgLum = sum / (data.length / 4); // 0..1

      // C) Auto contrast & brightness (prevents "white wash")
      const contrast = clamp(1.35 + avgLum * 0.85, 1.3, 2.2);
      const brightness = clamp(0.95 - avgLum * 0.30, 0.65, 0.95);
      P.style.filter = `contrast(${contrast}) brightness(${brightness})`;

      // D) Auto typography based on container width
      applyAutoTypography();
      window.addEventListener("resize", applyAutoTypography);
    };

    img.onerror = () => {
      P.style.color = "#fff";
      P.style.webkitTextFillColor = "#fff";
      P.textContent = "face.jpg not found. Check filename/path (case sensitive).";
    };

    function applyAutoTypography() {
      const w = P.getBoundingClientRect().width;

      // auto em: large width => smaller em (more detail)
      const em = clamp(0.95 - (w / 1000) * 0.55, 0.45, 0.85);

      const lh = clamp(em * 0.88, 0.38, 0.75);
      const ls = -clamp(em * 0.16, 0.06, 0.12);

      P.style.fontSize = em.toFixed(3) + "em";
      P.style.lineHeight = lh.toFixed(3) + "em";
      P.style.letterSpacing = ls.toFixed(3) + "em";
    }

    // center-crop cover draw (so analysis matches your cover rendering)
    function drawCover(ctx, img, w, h) {
      const ir = img.width / img.height;
      const cr = w / h;

      let sx = 0, sy = 0, sw = img.width, sh = img.height;
      if (ir > cr) {
        sw = img.height * cr;
        sx = (img.width - sw) / 2;
      } else {
        sh = img.width / cr;
        sy = (img.height - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);
    }

    function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }
  </script>
</body>
</html>
